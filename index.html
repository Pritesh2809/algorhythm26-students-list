<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALGORHYTHM'26 ‚Äì Dashboard</title>

  <style>
    :root{
      --primary:#0f2a44;
      --accent:#00bcd4;
      --bg:#f4f6f9;
      --card:#ffffff;
      --muted:#6b7280;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:system-ui,-apple-system,sans-serif;
      background:var(--bg);
      padding:14px;
    }

    /* HEADER */
    .header{
      text-align:center;
      margin-bottom:16px;
    }
    .header h1{
      margin:0;
      font-size:1.4rem;
      color:var(--primary);
    }
    .header p{
      margin:4px 0 0;
      font-size:13px;
      color:var(--muted);
    }

    /* SECTION */
    .section{
      background:var(--card);
      border-radius:16px;
      padding:16px;
      margin-bottom:16px;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
    }
    .section-title{
      font-weight:700;
      color:var(--primary);
      margin-bottom:12px;
      font-size:15px;
    }

    /* STATS */
    .stat-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .stat-value{
      font-size:1.6rem;
      font-weight:800;
      color:var(--accent);
    }

    /* LEADERBOARD */
    .leader-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      background:#f1f5f9;
      border-radius:12px;
      margin-bottom:10px;
    }
    .rank{
      font-weight:700;
      color:var(--primary);
    }

    /* INPUTS */
    select,input,button{
      width:100%;
      padding:14px;
      font-size:16px;
      border-radius:14px;
      border:1px solid #d1d5db;
    }
    button{
      background:var(--accent);
      color:white;
      border:none;
      font-weight:600;
    }

    /* TABLE */
    .table-wrapper{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }

    table{
      width:100%;
      min-width:720px;
      border-collapse:collapse;
    }

    thead{
      background:var(--primary);
      color:white;
      position:sticky;
      top:0;
    }

    th,td{
      padding:12px;
      font-size:14px;
      text-align:left;
      border-bottom:1px solid #e5e7eb;
    }

    tbody tr:nth-child(even){
      background:#f9fafb;
    }

    .hidden{display:none}
  </style>
</head>

<body>

<div class="header">
  <h1>ALGORHYTHM'26</h1>
  <p>Mobile Admin Dashboard</p>
</div>

<!-- OVERALL STATS -->
<div class="section">
  <div class="stat-row">
    <span>Total Registrations</span>
    <span id="overallCount" class="stat-value">0</span>
  </div>
</div>

<!-- TOP 3 -->
<div class="section">
  <div class="section-title">üèÜ Top 3 Referrals</div>
  <div id="overallLeaderboard"></div>
</div>

<!-- EVENT SELECT -->
<div class="section">
  <select id="eventSelect">
    <option value="">Select Event</option>
  </select>
</div>

<!-- EVENT DETAILS -->
<div id="eventSection" class="hidden">

  <div class="section">
    <div class="stat-row">
      <span>Event Registrations</span>
      <span id="eventCountText" class="stat-value">0</span>
    </div>
  </div>

  <div class="section">
    <input id="searchInput" placeholder="Search name / referral / mobile">
  </div>

  <div class="section">
    <button id="exportBtn">Export Event to Excel</button>
  </div>

  <!-- TABLE SECTION -->
  <div class="section">
    <div class="section-title">Participants</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Email</th>
          <th>Mobile</th>
          <th>Referral</th>
          <th>College</th>
        </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  const SHEET_ID="1I5r5Zy69lSOB3-0_kjm94Twe20zfU_Xz3oLbmRmXe7A";
  const SHEET_NAME="Form Responses 1";
  const IGNORE=["Not interested in Slot 1","Not interested in Slot 2","Not Interested"];
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}`;

  let eventData={},allData=[],currentData=[];

  fetch(url).then(r=>r.text()).then(d=>{
    const json=JSON.parse(d.substring(47).slice(0,-2));
    json.table.rows.forEach(row=>{
      const referral=row.c[6]?.v||"";
      const student={
        name:row.c[2]?.v||"",
        email:row.c[3]?.v||"",
        mobile:row.c[4]?.v||"",
        referral,
        college:row.c[7]?.v||""
      };
      [row.c[10]?.v,row.c[11]?.v].forEach(ev=>{
        if(ev && !IGNORE.includes(ev)){
          eventData[ev]=eventData[ev]||[];
          eventData[ev].push(student);
          if(referral) allData.push(student);
        }
      });
    });

    overallCount.textContent=allData.length;
    renderTop3();
    populateEvents();
  });

  function renderTop3(){
    const map={};
    allData.forEach(s=>map[s.referral]=(map[s.referral]||0)+1);
    overallLeaderboard.innerHTML="";
    Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,3)
            .forEach(([r,c],i)=>{
              overallLeaderboard.innerHTML+=`
        <div class="leader-row">
          <span class="rank">#${i+1} ${r}</span>
          <strong>${c}</strong>
        </div>`;
            });
  }

  function populateEvents(){
    Object.keys(eventData).sort().forEach(e=>{
      const o=document.createElement("option");
      o.value=e;o.textContent=e;
      eventSelect.appendChild(o);
    });
  }

  eventSelect.onchange=()=>{
    if(!eventSelect.value){
      eventSection.classList.add("hidden");
      return;
    }
    currentData=eventData[eventSelect.value];
    eventCountText.textContent=currentData.length;
    renderTable(currentData);
    eventSection.classList.remove("hidden");
  };

  function renderTable(data){
    tableBody.innerHTML="";
    data.forEach((s,i)=>{
      tableBody.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${s.name}</td>
        <td>${s.email}</td>
        <td>${s.mobile}</td>
        <td>${s.referral}</td>
        <td>${s.college}</td>
      </tr>`;
    });
  }

  searchInput.oninput=()=>{
    const q=searchInput.value.toLowerCase();
    renderTable(currentData.filter(s=>
            s.name.toLowerCase().includes(q)||
            s.referral.toLowerCase().includes(q)||
            s.mobile.includes(q)||
            s.college.toLowerCase().includes(q)
    ));
  };

  exportBtn.onclick=()=>{
    let csv="Name,Email,Mobile,Referral,College\n";
    currentData.forEach(s=>{
      csv+=`"${s.name}","${s.email}","${s.mobile}","${s.referral}","${s.college}"\n`;
    });
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download=`${eventSelect.value.replace(/\s+/g,"_")}.xlsx`;
    a.click();
  };
</script>

</body>
</html>
